function translatorConfig($translateProvider){$translateProvider.useSanitizeValueStrategy(null),$translateProvider.translations("en",{YOU:"You",AGENT:"Agent",CONNECTING:"Connecting...",SEND:"Send",SENDAMESSAGE:"Send a message...",SENDFILE:"Send file",SCREENSHARE:"Share screen",WEBCAM:"Webcam",AGENTNOTCONNECTED:"Agent is not connected",AGENTCONNECTED:"Agent is connected",AGENTLEFT:"Agent left",FAILEDTOCONNECT:"Failed to bypass Firewall rules. It seems that target user did not receive your screen. Please ask him reload the page and try again.",AGENTCONNECTED:"Agent is connected",AGENTTRYINGTOCONNECT:"Agent is trying to connect"}).translations("es",{YOU:"Tú",AGENT:"Agente",CONNECTING:"Conectando...",SEND:"Enviar",SENDAMESSAGE:"Enviar un mensaje...",SENDFILE:"Enviar archivos",SCREENSHARE:"Compartir pantalla",WEBCAM:"Webcam",AGENTNOTCONNECTED:"El agente no está conectado",AGENTCONNECTED:"El agente está conectado",AGENTLEFT:"El agente ha abandonado",FAILEDTOCONNECT:"Failed to bypass Firewall rules. It seems that target user did not receive your screen. Please ask him reload the page and try again.",AGENTCONNECTED:"El agente está conectado",AGENTTRYINGTOCONNECT:"El agente está intentando conectar"}).translations("eu",{YOU:"Tú",AGENT:"Agente",CONNECTING:"Konektatzen...",SEND:"Enviar",SENDAMESSAGE:"Mezu bat bidali...",SENDFILE:"Enviar archivos",SCREENSHARE:"Compartir pantalla",WEBCAM:"Webcam",AGENTNOTCONNECTED:"El agente no está conectado",AGENTCONNECTED:"El agente está conectado",AGENTLEFT:"El agente ha abandonado",FAILEDTOCONNECT:"Failed to bypass Firewall rules. It seems that target user did not receive your screen. Please ask him reload the page and try again.",AGENTCONNECTED:"El agente está conectado",AGENTTRYINGTOCONNECT:"El agente está intentando conectar"}),$translateProvider.fallbackLanguage("en"),$translateProvider.registerAvailableLanguageKeys(["en","es","eu"],{"en*":"en","eu*":"eu","es*":"es","*":"en"}),$translateProvider.determinePreferredLanguage()}function config($stateProvider,$urlRouterProvider,$locationProvider,$logProvider){$urlRouterProvider.otherwise("/index.html");$logProvider.debugEnabled(!1),$stateProvider.state("bots",{url:"",templateUrl:"views/webchat.html",controller:"WebChatController",controllerAs:"bots"})}function wsWebCChat($websocket,$log,$wsEndPoint,$timeout){var collection=[],dataStream=null,name="";function onConnected(){$log.debug("ON CONNECTED"),methods.onConnected()}var methods={collection:collection,connect:function(botid,clientid){$log.debug("TIMEOUT",$websocket.maxTimeout),null==dataStream&&((dataStream=$websocket($wsEndPoint+"/"+botid+"/"+clientid,null,{useApplyAsync:!0,maxTimeout:3e4,reconnectIfNotNormalClose:!0})).onOpen(function(){$log.debug("DATASTREAM OPEN"),onConnected()}),dataStream.onclose=function(e){console.log("onclose",dataStream),$log.debug("RECONNECTING SOCKET AFTER CLOSE"),onConnected()},dataStream.onError(function(){console.log("on error",dataStream),$log.debug("CONNECTION ERROR, reconnecting"),onConnected()}),dataStream.onMessage(function(message){$log.debug(message);var msg=JSON.parse(message.data);!msg.action||"agent_writing_on"!=msg.action&&"agent_writing_off"!=msg.action?(msg.type="reply",msg.from=name,msg.date=(new Date).toLocaleTimeString(),$log.debug(msg),collection.push(msg),methods.onMessage(msg)):methods.onAgentWriting(msg.action,msg)}))},onConnected:null,send:function(msg){var msg2=angular.copy(msg);"attach"!=msg.message&&(msg2.message={text:msg.message}),(!msg.action||msg.action&&"writing_on"!=msg.action&&"writing_off"!=msg.action)&&(collection.push(msg2),methods.onMessage(msg2),"attach"!=msg.message&&""!=msg.payload&&(msg.message="")),dataStream.send(JSON.stringify(msg))},disconnect:function(){$log.debug("DISCONNECTING MINICHAT"),null!=dataStream&&dataStream.close()},onMessage:function(){},isConnected:function(){return dataStream&&1==dataStream.readyState},onAgentWriting:function(){}};return methods}function WebChatController(wsWebCChat,$scope,$timeout,$rootScope,$location,FileUploader,$translate,$sce,$http){var vm=this;this.botid="",this.idbot="",this.color="#008ce6",this.startintent="",this.sessionintent="",this.testmsg="",this.title="",this.pending=0,vm.connected=!1,$scope.openChat=!1,this.windowWidth=void 0,this.boticon="img/chatbot.png",this.chaticon="",this.humanboticon="img/chatbot.png",this.chaticonbg="",this.hideicon=!1,this.whatsapp="",this.isWhatsapp=!1,this.showattach=!1,this.whatsappicon="https://cdn.aunoa.ai/img/whatsapp.png";var audio=new Audio("img/play.mp3");function doApplyScroll(){var container=$("#testchat");if(container.length>0){var h=window.innerHeight;container.slimScroll({height:h+"px",scrollTo:container[0].scrollHeight+50}),carouselNormalization()}}function applyScroll(){$("img").bind("load",function(){doApplyScroll()}),$timeout(function(){doApplyScroll()},100),$timeout(function(){doApplyScroll()},500),$("#texttochat").focus()}this.userParams=void 0,this.maxHistory=20,this.openafter=0,this.opennow=!1,this.flush=!1,this.remoteconfig=!1,this.poweredby=!1,this.isSharingScreen=!1,this.isWebcam=!1,this.screenshare=!1,this.webcam=!1,this.stylechaticon="",this.isInCcare=!1,this.idconversation=0,this.playsounds=!0,this.isWriting=!1,this.agentWriting=!1,vm.isMobile=function(){return/android|webos|iphone|ipad|ipod|blackberry|mobile/i.test(navigator.userAgent.toLowerCase())},vm.initPlugin=function(){$(".floating-chat").css({background:vm.color});var element=$(".floating-chat"),chatwindow=$("#chatwindow"),browser=$("#webBrowser");function showHideOnPage(){var u=vm.userParams.currentPage;if(!vm.flush&&"0"!=vm.showWhen&&u&&""!=u){for(var found=!1,i=0;i<vm.urls.length;i++)if(0==u.indexOf(vm.urls[i])){found=!0;break}found||"1"!=vm.showWhen||$("body").remove(),found&&"2"==vm.showWhen&&$("body").remove()}}if(vm.poweredby&&chatwindow.addClass("powered"),setTimeout(function(){element.css({display:"flex"}),browser.hide(),setTimeout(function(){element.addClass("enter")},500)},500),element.find(".chat").removeClass("enter").hide(),vm.isWhatsapp)vm.stylechaticon="",""!=vm.chaticonbg&&(vm.stylechaticon="#chatwindow:not(.expand) {background: "+vm.chaticonbg+" !important;}"),vm.stylechaticon+="#openbtn{\twidth: 60px;\theight: 60px;\tbackground: #fff url("+vm.whatsappicon+") center/cover no-repeat;background-size: contain;\tbackground-color: transparent;}#openbtn::before{\tcontent: '' !important;}",element.click(function(){window.open("https://api.whatsapp.com/send?phone="+vm.whatsapp+"&text="+vm.startintent,"_blank")}),window.addEventListener("message",function(event){var data=JSON.parse(event.data);"addUserParams"==data.action&&data.value&&(vm.userParams=data.value,showHideOnPage()),"whatsappchaticon"==data.action&&data.value&&""!=data.value.trim()&&(vm.whatsappicon=data.value,vm.stylechaticon="",""!=vm.chaticonbg&&(vm.stylechaticon="#chatwindow:not(.expand) {background: "+vm.chaticonbg+" !important;}"),vm.stylechaticon+="#openbtn{\twidth: 60px;\theight: 60px;\tbackground: #fff url("+vm.whatsappicon+") center/cover no-repeat;background-size: contain;\tbackground-color: transparent;}#openbtn::before{\tcontent: '' !important;}")}),parent.postMessage('{"action": "loaded"}',"*"),vm.isMobile()&&parent.postMessage('{"action": "isMobile"}',"*");else{function openElement(){$scope.openChat=!0,$("#chatwindow").removeClass("chatwindowhide"),$rootScope.pendingMinichat=0,parent.postMessage('{"action": "openChat"}',"*"),chatwindow.find(">i").hide(),chatwindow.addClass("expand"),chatwindow.find(".chat").addClass("enter").show(),chatwindow.off("click",openElement),$("#chatwindow").find(".header button.plugin-button").click(closeElement),browser.find(".header button.plugin-button").click(closeBrowser),applyScroll()}function closeElement(){$scope.openChat=!1,!0!==vm.hideicon&&"true"!==vm.hideicon||$("#chatwindow").addClass("chatwindowhide"),browser.hide(),element.removeClass("withbrowser"),parent.postMessage('{"action": "closeChat"}',"*"),element.find(">i").show(),element.removeClass("expand").removeClass("expandmobile"),element.find(".header button.plugin-button").off("click",closeElement),setTimeout(function(){element.find(".chat").removeClass("enter").hide(),element.click(openElement)},100)}function closeBrowser(){browser.hide(),parent.postMessage('{"action": "openChat"}',"*"),element.removeClass("withbrowser")}element.click(openElement),browser.hide(),window.onkeydown=function(evt){27==(evt=evt||window.event).keyCode&&closeElement()},window.addEventListener("message",function(event){try{var data=JSON.parse(event.data);if("maxHistory"==data.action&&(vm.maxHistory=data.value),"addUserParams"==data.action&&data.value&&(vm.userParams=data.value,showHideOnPage()),"boticon"==data.action&&""!=data.value&&""!=data.value&&(vm.boticon=data.value,vm.humanboticon=data.value),"showattach"==data.action&&(data.value&&!0===data.value||"true"==data.value)&&(vm.showattach=data.value),"hideicon"==data.action&&(vm.hideicon=data.value,!0!==vm.hideicon&&"true"!==vm.hideicon||$("#chatwindow").addClass("chatwindowhide")),"chaticon"==data.action&&""!=data.value&&(vm.chaticon=data.value,vm.stylechaticon="",""!=vm.chaticon&&(vm.stylechaticon+="#openbtn{\twidth: 60px;\theight: 60px;\tbackground: #fff url("+vm.chaticon+") center/cover no-repeat;background-size: contain;\tbackground-color: transparent;}#openbtn::before{\tcontent: '' !important;}")),"openChat"==data.action&&openElement(),"addContext"==data.action&&(vm.userParams=void 0===vm.userParams?data.message:Object.assign(vm.userParams,data.message)),"toggleChat"==data.action&&($scope.openChat?closeElement():openElement()),"sendMsg"==data.action&&data.message&&vm.chatClickButton(data.message,""),"closeChat"==data.action&&closeElement(),"windowWidth"==data.action&&(vm.windowWidth=data.value,data.value<=720?$("body").addClass("mobile"):$("body").removeClass("mobile"),applyScroll()),"startScreensharing"==data.action&&(vm.isSharingScreen=!0),"stopScreensharing"==data.action&&(vm.isSharingScreen=!1,vm.sendInternalMessage("userStopedVideoSession")),"startWebcam"==data.action&&(vm.isWebcam=!0),"stopWebcam"==data.action&&(vm.sendInternalMessage("userStopedVideoSession"),vm.isWebcam=!1),data.action,"screenshareUnsupported"==data.action&&(vm.screenshare=!1),data.action,"webcamUnsupported"==data.action&&(vm.webcam=!1),"localMessage"==data.action){var msg=data.msg;$scope.testChatMessages.push({type:"internal",message:{title:"",subtitle:$translate.instant(msg)},timestampms:Date.now(),timestamp:Date.now()/1e3}),applyScroll()}"openMedia"==data.action&&vm.sendInternalMessage("userStartedVideoSession")}catch(err){console.log("ERROR ON MESSAGE DATA",err)}}),vm.screenshare&&parent.postMessage('{"action": "screenshare"}',"*"),vm.webcam&&parent.postMessage('{"action": "webcam"}',"*"),parent.postMessage('{"action": "loaded"}',"*"),vm.isMobile()&&parent.postMessage('{"action": "isMobile"}',"*"),this.opennow&&$timeout(function(){openElement()},1e3*this.openafter)}},vm.sendInternalMessage=function(message){var msg={action:"ccareinternal"};msg.recipient=vm.botid,msg.sender=vm.userid,msg.idchannel="13",msg.idbot=vm.idbot,msg.idconversation=vm.idconversation,msg.message=message,msg.payload="",msg.timestamp=Date.now()/1e3,msg.timestampms=Date.now(),wsWebCChat.send(msg)},vm.initParams=function(){var t=window.location.search.substring(1).split(";");if(t.length>0&&!vm.remoteconfig){if(this.botid=t[0],2==t.length)if("%"==decodeURIComponent(t[1]).charAt(0)){var c=decodeURIComponent(t[1]).replace("%","#");""!=c&&"#"!=c1&&(this.color=c)}else""!=t[1]&&(this.startintent=decodeURIComponent(t[1]));if(t.length>=3){var c1=decodeURIComponent(t[1]).replace("%","#");""!=c1&&"#"!=c1&&(this.color=c1),""!=t[2]&&(this.startintent=decodeURIComponent(t[2]))}t.length>=4&&""!=t[3]&&(this.title=decodeURIComponent(t[3])),t.length>=5&&""!=t[4]&&(this.sessionintent=decodeURIComponent(t[4])),t.length>=6&&t[5]&&""!=t[5].trim()&&vm.isMobile()&&(this.whatsapp=decodeURIComponent(t[5]),this.isWhatsapp=!0),t.length>=7&&t[6]&&""!=t[6].trim()&&(this.chaticonbg=decodeURIComponent(t[6]).replace("%","#"))}vm.initPlugin()},vm.getConfig=function(){var t=window.location.search.substring(1).split(";"),t1=window.location.search.substring(1).split("&");"flush=true"==t1[t1.length-1]&&(vm.flush=!0),vm.botid=t[0];var temp=vm.botid.split("-"),id=temp[0];vm.idbot=id;var config="https://cdn.aunoa.ai/config/"+id+".json";"00"==temp[1]&&(config="https://cdn.aunoa.ai/config/"+t[0]+".json"),vm.flush&&(config=config+"?t="+Date.now()),$http.get(config).then(function(response){for(var keys=Object.keys(response.data),i=0;i<keys.length;i++)vm[keys[i]]=response.data[keys[i]],"boticon"!=keys[i]||response.data.humanboticon||(vm.humanboticon=vm[keys[i]]);vm.whatsapp&&""!=vm.whatsapp&&vm.isMobile()&&(vm.isWhatsapp=!0),""!=vm.chaticon&&"fa fa-2x fa-comments"!=vm.chaticon&&(vm.stylechaticon="",vm.stylechaticon+="#openbtn{\twidth: 60px;\theight: 60px;\tbackground: #fff url("+vm.chaticon+") center/cover no-repeat;background-size: contain;\tbackground-color: transparent;}#openbtn::before{\tcontent: '' !important;}"),vm.remoteconfig=!0,vm.flush&&(vm.opennow=!1),vm.initParams()},function(response){vm.initParams()})},vm.getConfig(),$scope.trustAsHtml=function(string){return $sce.trustAsHtml(string)},this.getUserId=function(){if(""!=vm.botid){var uuid="";if("localStorage"in window)try{if(uuid=window.localStorage.getItem("webchatbotuserid_"+vm.botid))return uuid}catch(err){}if(uuid="xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx".replace(/[xy]/g,function(c){var r=16*Math.random()|0;return("x"==c?r:3&r|8).toString(16)}),"localStorage"in window)try{window.localStorage.setItem("webchatbotuserid_"+vm.botid,uuid)}catch(err){}return uuid}},this.userid=this.getUserId(),$timeout(function(){vm.connectIfVisible()}),vm.connectIfVisible=function(){""!=vm.botid&&$scope.openChat?wsWebCChat.connect(vm.botid,vm.userid):$timeout(vm.connectIfVisible,1e3)},$rootScope.pendingMinichat=0,$rootScope.changeChat=function(){$scope.openChat=!$scope.openChat,$scope.openChat&&($rootScope.pendingMinichat=0,$timeout(function(){var container=$("#testchat");container.slimScroll({scrollTo:container[0].scrollHeight})},100))},$scope.mouseDown=function($event){$event.stopPropagation()},jQuery(document).on("keydown",function(e){27==e.keyCode&&$scope.openChat&&$scope.$apply(function(){$rootScope.changeChat()})}),jQuery(document).on("mousedown",function(e){$scope.openChat&&$scope.$apply(function(){$rootScope.changeChat()})}),$scope.$on("$destroy",function(){wsWebCChat.disconnect()}),this.getLastMessages=function(){if("localStorage"in window)try{var messages=window.localStorage.getItem("lastMessages_"+vm.botid);if(messages)return JSON.parse(messages)}catch(err){}return[]},wsWebCChat.onConnected=function(){if(wsWebCChat.isConnected()){vm.connected=!0;for(var msgs=vm.getLastMessages(),i=0;i<msgs.length;i++)"reply"==msgs[i].type&&msgs[i].ccare&&msgs[i].ccare.idconversation?(vm.isInCcare=!0,vm.idconversation=msgs[i].ccare.idconversation):"reply"==msgs[i].type&&(vm.isInCcare=!1,vm.agentWriting=!1);if($("#connecting").hide(),""!=vm.startintent&&0==msgs.length)vm.chatClickButton(vm.startintent,"");else if(msgs.length>0){$scope.testChatMessages=$scope.testChatMessages.concat(msgs);var lastmsg=$scope.testChatMessages[$scope.testChatMessages.length-1],diff=(Date.now()-1e3*lastmsg.timestamp)/1e3;""!=vm.sessionintent&&diff>1800&&vm.chatClickButton(vm.sessionintent,"")}$scope.$apply(),applyScroll(),$scope.$watchCollection("testChatMessages",function(){var msgs=$scope.testChatMessages.filter(function(m){return"internal"!=m.type}),msgs1=msgs.slice(Math.max(msgs.length-vm.maxHistory,0));if("localStorage"in window)try{window.localStorage.setItem("lastMessages_"+vm.botid,JSON.stringify(msgs1))}catch(err){}}),parent.postMessage('{"action": "event", "event": "connected"}',"*")}else vm.connected=!1,$("#connecting").show()},wsWebCChat.onAgentWriting=function(status,msg){vm.agentWriting="agent_writing_on"==status,vm.agentWriting&&applyScroll()},wsWebCChat.onMessage=function(msg){if(!msg.action||"ccareinternal"!=msg.action){msg.attach&&(msg.message={},msg.message.type=msg.mediatype,msg.message.attach=msg.attach);var lasttimestamp=0;if($scope.testChatMessages.length>0){var newArray=$scope.testChatMessages.filter(function(each){return"user"!==each.type});newArray.length>0&&(lasttimestamp=newArray[newArray.length-1].timestamp)}if(msg.lang&&""!=msg.lang&&$translate.use()!=msg.lang&&$translate.getAvailableLanguageKeys().indexOf(msg.lang)>=0&&$translate.use(msg.lang),"user"!=msg.type&&(vm.agentWriting=!1),"user"==msg.type||msg.timestamp>lasttimestamp){var eventtype="msg_received";"user"==msg.type&&(eventtype="msg_sent");var event={action:"event",event:eventtype,arguments:[msg]};parent.postMessage(JSON.stringify(event),"*"),"user"!=msg.type&&vm.playsounds&&audio.play(),msg.isInCcare=!1,"reply"==msg.type&&msg.ccare&&msg.ccare.idconversation?(vm.isInCcare=!0,msg.isInCcare=!0,vm.idconversation=msg.ccare.idconversation):"reply"==msg.type&&(vm.isInCcare=!1),$scope.testChatMessages.push(msg),0==$scope.openChat&&$rootScope.pendingMinichat++,applyScroll()}}},$scope.testChatMessages=[],vm.firstMessage=!1,this.chatClickButton=function(label,payload){this.isWriting=!1;var userLang=navigator.language||navigator.userLanguage;if(userLang.includes("-")>0){var temp=userLang.split("-");userLang=temp[0]}else userLang.includes("_")>0&&(userLang=(temp=userLang.split("_"))[0]);var msg={channel:"WEBCHATBOT"};msg.recipient=vm.botid,msg.sender=vm.userid,msg.date=(new Date).toLocaleTimeString(),msg.type="user",msg.message=label,msg.profile={},vm.firstMessage||(msg.profile.locale=userLang),vm.userParams&&(msg.profile=Object.assign(msg.profile,vm.userParams),vm.userParams=void 0),msg.payload=payload,msg.timestamp=Date.now()/1e3,wsWebCChat.send(msg),this.testmsg="",this.firstMessage=!0},this.sendTestMsg=function(){this.testmsg.trim().length>0&&this.chatClickButton(this.testmsg,"")},vm.sendIsWriting=function(status){var msg={action:"writing_on"};this.isWriting||(msg.action="writing_off"),msg.recipient=vm.botid,msg.sender=vm.userid,msg.idchannel="13",msg.idbot=vm.idbot,msg.idconversation=vm.idconversation,msg.message=msg.action,msg.payload="",msg.timestamp=Date.now()/1e3,msg.timestampms=Date.now(),wsWebCChat.send(msg)},vm.sendWriting=function(){vm.isInCcare&&(0==this.testmsg.length&&this.isWriting?(this.isWriting=!1,vm.sendIsWriting()):this.isWriting||(this.isWriting=!0,vm.sendIsWriting()))},FileUploader.FileSelect.prototype.isEmptyAfterSelection=function(){return!0};var idbot=vm.botid.split("-")[0],uploader=$scope.uploader=new FileUploader({url:"https://api.aunoa.ai/bots/"+idbot+"/upload?path=aunoa-attachments/"+idbot+"/"+vm.userid,alias:"uploads",autoUpload:!0,removeAfterUpload:!0});uploader.onAfterAddingFile=function(fileItem){$scope.uploadProgress=0,$timeout(function(){},100)},uploader.onProgressAll=function(progress){$scope.uploadProgress=progress,applyScroll()},uploader.onSuccessItem=function(fileItem,response,status,headers){if(response&&response.url){var temp=response.url.split("."),ext=temp[temp.length-1],msg={};switch(msg.attach=response.url,ext){case"mp4":msg.mediatype="video";break;case"mp3":msg.mediatype="audio";break;case"png":case"jpg":case"gif":case"jpeg":msg.mediatype="image";break;default:msg.mediatype="document"}msg.channel="WEBCHATBOT",msg.recipient=vm.botid,msg.sender=vm.userid,msg.date=(new Date).toLocaleTimeString(),msg.type="user",msg.message="attach",msg.profile={},msg.payload=response.url,wsWebCChat.send(msg),this.testmsg=""}$scope.uploadProgress=-1,$timeout(function(){uploader.cancelAll(),uploader.clearQueue()},100)},uploader.onErrorItem=function(fileItem,response,status,headers){$scope.uploadProgress=-1,$timeout(function(){uploader.cancelAll(),uploader.clearQueue()},100)},uploader.onCancelItem=function(fileItem,response,status,headers){$scope.uploadProgress=-1,$timeout(function(){uploader.cancelAll(),uploader.clearQueue()},100)},$scope.launchFilePicker=function(){vm.connected&&angular.element("#fileDialog").trigger("click")},$scope.openModal=function(msg,action){var url=action.link,newwindow=!1;if(action.hasOwnProperty("newwindow")&&(newwindow=action.newwindow),url=url.replace("http://","https://"),newwindow||0!=url.indexOf("https://"))window.open(url);else{if(0!=url.indexOf("http"))return;url.includes("?")>0?url+="&":url+="?";var msgsend={action:"openBrowser",url:url=url+"sender="+vm.userid+"&recipient="+msg.recipient+"&channel=13"};if(parent.postMessage(JSON.stringify(msgsend),"*"),vm.windowWidth>720){var webbrowser=$("#webBrowser");webbrowser.show(),webbrowser.find(">i").hide(),webbrowser.addClass("expand"),webbrowser.find(".chat").addClass("enter").show(),$("#chatwindow").addClass("withbrowser"),$("#webiframe").attr("src",url)}}},window.closeModal=function(){$("#webBrowser").modal("hide")},$scope.launchScreenshare=function(){vm.isSharingScreen?(parent.postMessage('{"action": "stopScreensharing"}',"*"),vm.isSharingScreen=!1):(parent.postMessage('{"action": "startScreensharing","name":"'+vm.idbot+"_"+vm.userid+'"}',"*"),vm.isSharingScreen=!0)},$scope.launchWebcam=function(){vm.isWebcam?(parent.postMessage('{"action": "stopWebcam"}',"*"),vm.isWebcam=!1):(parent.postMessage('{"action": "startWebcam","name":"'+vm.idbot+"_"+vm.userid+'"}',"*"),vm.isWebcam=!0)}}function carouselNormalization(){$(".carousel").each(function(){var tallest,heights=[],items=$(this).find(".item");items.each(function(){heights.push($(this).height())}),tallest=Math.max.apply(null,heights),items.each(function(){$(this).css("min-height",tallest+"px"),$(this).find(".wraper").each(function(){$(this).css("min-height",tallest+"px")})})})}function carrusel_swipe(){$(".carousel").hammer().off(),$(".carousel").hammer();var pointerXCoord=0,imageLeftCord=0,carouselWidth=$(".carousel-inner").width(),lastMove="";function snapLeft(t){$(".item").css({transition:"",transform:""}),$(".item").removeClass("prev"),$(".item").removeClass("next"),$(t).carousel("prev"),setTimeout(function(){},600)}function snapRight(t){$(".item").css({transition:"",transform:""}),$(".item").removeClass("prev"),$(".item").removeClass("next"),$(t).carousel("next"),setTimeout(function(){},600)}$(".carousel-control.left").click(function(){snapLeft()}),$(".carousel-control.right").click(function(){snapRight()}),$(".carousel").hammer().on("panstart panend panleft panright",function(ev){$(ev.target).carousel("pause");var prev=$(".item.active").prev();void 0===prev[0]&&(prev=$(".carousel-inner").children().last()),prev.addClass("prev");var next=$(".item.active").next();if(void 0===next[0]&&(next=$(".carousel-inner").children().first()),next.addClass("next"),"panstart"===ev.type)return pointerXCoord=ev.gesture.pointers[0].pageX,0;if(pointerXCoord!==ev.gesture.pointers[0].pageX){lastMove=ev.type;var diff=ev.gesture.pointers[0].pageX-pointerXCoord;$(".item.active").css({transition:"initial",transform:"translate3d("+(imageLeftCord+diff)+"px, 0, 0)"}),$(".item.next").css({transition:"initial",transform:"translate3d("+(imageLeftCord+diff+carouselWidth)+"px, 0, 0)"}),$(".item.prev").css({transition:"initial",transform:"translate3d("+(imageLeftCord+diff-carouselWidth)+"px, 0, 0)"}),imageLeftCord+=diff,pointerXCoord=ev.gesture.pointers[0].pageX}if("panend"===ev.type){if(imageLeftCord>carouselWidth/2&&"panright"===lastMove)return snapLeft(ev.target),0;if(imageLeftCord<-carouselWidth/2&&"panleft"===lastMove)return snapRight(ev.target),0;$(".item").css({transition:"",transform:""}),$(".carousel").carousel("cycle"),carouselWidth=$(".carousel-inner").width(),imageLeftCord=0,pointerXCoord=0,lastMove=""}})}$(document).ready(function(){function fix_height(){var heightWithoutNavbar=$("body > #wrapper").height()-61;$(".sidebard-panel").css("min-height",heightWithoutNavbar+"px");var navbarHeigh=$("nav.navbar-default").height(),wrapperHeigh=$("#page-wrapper").height();navbarHeigh>wrapperHeigh&&$("#page-wrapper").css("min-height",navbarHeigh+"px"),navbarHeigh<wrapperHeigh&&$("#page-wrapper").css("min-height",$(window).height()+"px"),$("body").hasClass("fixed-nav")&&(navbarHeigh>wrapperHeigh?$("#page-wrapper").css("min-height",navbarHeigh-60+"px"):$("#page-wrapper").css("min-height",$(window).height()-60+"px"))}$(window).bind("load resize scroll",function(){$("body").hasClass("body-small")||fix_height()}),$(window).scroll(function(){$(window).scrollTop()>0&&!$("body").hasClass("fixed-nav")?$("#right-sidebar").addClass("sidebar-top"):$("#right-sidebar").removeClass("sidebar-top")}),setTimeout(function(){fix_height()})}),$(function(){$(window).bind("load resize",function(){})}),function($,window,document){var MAX_LENGTH_ALLOWED_KEYS=[8,9,17,18,37,38,39,40,91,46];$.emojiarea={assetsPath:"",iconSize:25,emojiAttachmentLocation:"bottom right",emojiMenuLocation:"top left",icons:{}};var defaultRecentEmojis=":joy:,:kissing_heart:,:heart:,:heart_eyes:,:blush:,:grin:,:+1:,:relaxed:,:pensive:,:smile:,:sob:,:kiss:,:unamused:,:flushed:,:stuck_out_tongue_winking_eye:,:see_no_evil:,:wink:,:smiley:,:cry:,:stuck_out_tongue_closed_eyes:,:scream:,:rage:,:smirk:,:disappointed:,:sweat_smile:,:kissing_closed_eyes:,:speak_no_evil:,:relieved:,:grinning:,:yum:,:laughing:,:ok_hand:,:neutral_face:,:confused:".split(",");$.fn.emojiarea=function(options){return options=$.extend({},options),console.log(options),this.each(function(){var originalInput=$(this),id=getGuid();new EmojiArea_Plain(originalInput,id,options),originalInput.attr({"data-emojiable":"converted","data-id":id,"data-type":"original-input"})})};var util={};util.restoreSelection=window.getSelection?function(savedSelection){var sel=window.getSelection();sel.removeAllRanges();for(var i=0,len=savedSelection.length;i<len;++i)sel.addRange(savedSelection[i])}:document.selection&&document.selection.createRange?function(savedSelection){savedSelection&&savedSelection.select()}:void 0,util.saveSelection=window.getSelection?function(){var sel=window.getSelection(),ranges=[];if(sel.rangeCount)for(var i=0,len=sel.rangeCount;i<len;++i)ranges.push(sel.getRangeAt(i));return ranges}:document.selection&&document.selection.createRange?function(){var sel=document.selection;return"none"!==sel.type.toLowerCase()?sel.createRange():null}:void 0,util.replaceSelection=window.getSelection?function(content){var range,sel=window.getSelection(),node="string"==typeof content?document.createTextNode(content):content;sel.getRangeAt&&sel.rangeCount&&((range=sel.getRangeAt(0)).deleteContents(),range.insertNode(node),range.setStart(node,0),window.setTimeout(function(){(range=document.createRange()).setStartAfter(node),range.collapse(!0),sel.removeAllRanges(),sel.addRange(range)},0))}:document.selection&&document.selection.createRange?function(content){var range=document.selection.createRange();"string"==typeof content?range.text=content:range.pasteHTML(content.outerHTML)}:void 0,util.insertAtCursor=function(text,el){text=" "+text;var startIndex,range,val=el.value;void 0!==el.selectionStart&&void 0!==el.selectionEnd?(startIndex=el.selectionStart,el.selectionEnd,el.value=val.substring(0,startIndex)+text+val.substring(el.selectionEnd),el.selectionStart=el.selectionEnd=startIndex+text.length):void 0!==document.selection&&void 0!==document.selection.createRange&&((range=document.selection.createRange()).text=text,range.select())},util.extend=function(a,b){if(void 0!==a&&a||(a={}),"object"==typeof b)for(var key in b)b.hasOwnProperty(key)&&(a[key]=b[key]);return a},util.escapeRegex=function(str){return(str+"").replace(/([.?*+^$[\]\\(){}|-])/g,"\\$1")},util.htmlEntities=function(str){return String(str).replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;").replace(/"/g,"&quot;")},util.emojiInserted=function(emojiKey,menu){ConfigStorage.get("emojis_recent",function(curEmojis){var pos=(curEmojis=curEmojis||defaultRecentEmojis||[]).indexOf(emojiKey);if(!pos)return!1;-1!=pos&&curEmojis.splice(pos,1),curEmojis.unshift(emojiKey),curEmojis.length>42&&(curEmojis=curEmojis.slice(42)),ConfigStorage.set({emojis_recent:curEmojis})})};var EmojiArea=function(){};EmojiArea.prototype.setup=function(){this.emojiMenu=new EmojiMenu(this),this.setupButton()},EmojiArea.prototype.setupButton=function(){var self=this,$button=$("[data-id="+this.id+"][data-type=picker]");$button.on("click",function(e){self.emojiMenu.show(self)}),this.$button=$button,this.$dontHideOnClick="emoji-picker"},EmojiArea.createIcon=function(emoji,menu){var category=emoji[0],row=emoji[1],column=emoji[2],name=emoji[3],filename=$.emojiarea.assetsPath+"/emoji_spritesheet_!.png",blankGifPath=$.emojiarea.assetsPath+"/blank.gif",iconSize=menu&&Config.Mobile?26:$.emojiarea.iconSize,xoffset=-iconSize*column,yoffset=-iconSize*row,scaledWidth=Config.EmojiCategorySpritesheetDimens[category][1]*iconSize,scaledHeight=Config.EmojiCategorySpritesheetDimens[category][0]*iconSize,style="display:inline-block;";return style+="width:"+iconSize+"px;",style+="height:"+iconSize+"px;",style+="background:url('"+filename.replace("!",category)+"') "+xoffset+"px "+yoffset+"px no-repeat;",'<img src="'+blankGifPath+'" class="img" style="'+(style+="background-size:"+scaledWidth+"px "+scaledHeight+"px;")+'" alt="'+util.htmlEntities(name)+'">'},$.emojiarea.createIcon=EmojiArea.createIcon;var EmojiArea_Plain=function($textarea,id,options){this.options=options,this.$textarea=$textarea,this.options.inputMethod="unicode",this.emojiPopup=options.emojiPopup,this.$editor=$textarea,this.id=id;var unicodeToImageText=this.emojiPopup.unicodeToImage($textarea.val());this.$editor.html(unicodeToImageText),this.$editor.attr({"data-id":id,"data-type":"input",placeholder:$textarea.attr("placeholder"),contenteditable:"true"});this.options.norealTime;var editorDiv=this.$editor;if(this.$editor.on("change keydown keyup resize scroll",function(e){-1!=MAX_LENGTH_ALLOWED_KEYS.indexOf(e.which)||(e.ctrlKey||e.metaKey)&&65==e.which||(e.ctrlKey||e.metaKey)&&67==e.which||!(editorDiv.text().length+editorDiv.find("img").length>=editorDiv.attr("maxlength"))||e.preventDefault()}),this.options.onPaste){var self=this;this.$editor.on("paste",function(e){if(e.preventDefault(),(e.originalEvent||e).clipboardData){var content=(e.originalEvent||e).clipboardData.getData("text/plain"),finalText=self.options.onPaste(content);document.execCommand("insertText",!1,finalText)}else if(window.clipboardData){content=window.clipboardData.getData("Text"),finalText=self.options.onPaste(content);document.selection.createRange().pasteHTML(finalText)}editorDiv.scrollTop(editorDiv[0].scrollHeight)})}$textarea.after("<i class='emoji-picker-icon emoji-picker "+this.options.popupButtonClasses+"' data-id='"+id+"' data-type='picker'></i>"),this.setup()};EmojiArea_Plain.prototype.insert=function(emoji){var insertionContent;insertionContent=this.emojiPopup.colonToUnicode(emoji),util.insertAtCursor(insertionContent,this.$textarea[0]),util.emojiInserted(emoji,this.menu),this.$textarea.trigger("change"),this.$textarea.focus()},EmojiArea_Plain.prototype.val=function(){return"\n"==this.$textarea?"":this.$textarea.val()},util.extend(EmojiArea_Plain.prototype,EmojiArea.prototype),jQuery.fn.hasScrollbar=function(){var scrollHeight=this.get(0).scrollHeight;return this.outerHeight()<scrollHeight};var EmojiMenu=function(emojiarea){var self=this;self.id=emojiarea.id;var $body=$(document.body);$(window);this.visible=!1,this.emojiarea=emojiarea,EmojiMenu.menuZIndex=5e3,this.$menu=$("<div>"),this.$menu.addClass("emoji-menu"),this.$menu.attr("data-id",self.id),this.$menu.attr("data-type","menu"),this.$menu.hide(),this.$itemsTailWrap=$('<div class="emoji-items-wrap1"></div>').appendTo(this.$menu),this.$categoryTabs=$('<table class="emoji-menu-tabs"><tr><td><a class="emoji-menu-tab icon-recent" ></a></td><td><a class="emoji-menu-tab icon-smile" ></a></td><td><a class="emoji-menu-tab icon-flower"></a></td><td><a class="emoji-menu-tab icon-bell"></a></td><td><a class="emoji-menu-tab icon-car"></a></td><td><a class="emoji-menu-tab icon-grid"></a></td></tr></table>').appendTo(this.$itemsTailWrap),this.$itemsWrap=$('<div class="emoji-items-wrap nano mobile_scrollable_wrap"></div>').appendTo(this.$itemsTailWrap),this.$items=$('<div class="emoji-items nano-content">').appendTo(this.$itemsWrap),$body.append(this.$menu),Config.Mobile||this.$itemsWrap.nanoScroller({preventPageScrolling:!0,tabIndex:-1}),$body.on("keydown",function(e){27!==e.keyCode&&9!==e.keyCode||self.hide()}),$body.on("message_send",function(e){self.hide()}),$body.on("mouseup",function(e){var target=(e=e.originalEvent||e).originalTarget||e.target||window;if(!$(target).hasClass(self.emojiarea.$dontHideOnClick)){for(;target&&target!=window;)if((target=target.parentNode)==self.$menu[0]||self.emojiarea&&target==self.emojiarea.$button[0])return;self.hide()}}),this.$menu.on("mouseup","a",function(e){return e.stopPropagation(),!1}),this.$menu.on("mousedown","a",function(e){return e.stopPropagation(),!1}),this.$menu.on("click","a",function(e){if($(this).hasClass("emoji-menu-tab"))return self.getTabIndex(this)!==self.currentCategory&&self.selectCategory(self.getTabIndex(this)),!1;var emoji=$(".label",$(this)).text();return window.setTimeout(function(){self.onItemSelected(emoji),self.hide()},0),e.stopPropagation(),!1}),this.selectCategory(0)};EmojiMenu.prototype.getTabIndex=function(tab){return this.$categoryTabs.find(".emoji-menu-tab").index(tab)},EmojiMenu.prototype.selectCategory=function(category){this.$categoryTabs.find(".emoji-menu-tab").each(function(index){index===category?this.className+="-selected":this.className=this.className.replace("-selected","")}),this.currentCategory=category,this.load(category),Config.Mobile||this.$itemsWrap.nanoScroller({scroll:"top"})},EmojiMenu.prototype.onItemSelected=function(emoji){this.emojiarea.$editor.text().length+this.emojiarea.$editor.find("img").length>=this.emojiarea.$editor.attr("maxlength")||this.emojiarea.insert(emoji)},EmojiMenu.prototype.load=function(category){var html=[],options=$.emojiarea.icons,path=$.emojiarea.assetsPath,self=this;path.length&&"/"!==path.charAt(path.length-1)&&(path+="/");var updateItems=function(){self.$items.html(html.join("")),Config.Mobile||setTimeout(function(){self.$itemsWrap.nanoScroller()},100)};if(category>0){for(var key in options)options.hasOwnProperty(key)&&options[key][0]===category-1&&html.push('<a href="javascript:void(0)" title="'+util.htmlEntities(key)+'">'+EmojiArea.createIcon(options[key],!0)+'<span class="label">'+util.htmlEntities(key)+"</span></a>");updateItems()}else ConfigStorage.get("emojis_recent",function(curEmojis){var key,i;for(curEmojis=curEmojis||defaultRecentEmojis||[],i=0;i<curEmojis.length;i++)key=curEmojis[i],options[key]&&html.push('<a href="javascript:void(0)" title="'+util.htmlEntities(key)+'">'+EmojiArea.createIcon(options[key],!0)+'<span class="label">'+util.htmlEntities(key)+"</span></a>");updateItems()})},EmojiMenu.prototype.reposition=function(attachmentLocation,menuLocation){this.tether=new Tether({element:'[data-id="'+this.id+'"][data-type="menu"]',target:'[data-id="'+this.id+'"][data-type="picker"]',attachment:attachmentLocation,targetAttachment:menuLocation,constraints:[{to:"html",pin:!0}]})},EmojiMenu.prototype.hide=function(callback){this.visible=!1,this.$menu.hide("fast")},EmojiMenu.prototype.show=function(emojiarea){if(console.log(emojiarea),this.visible)return this.hide();this.reposition(emojiarea.options.emojiAttachmentLocation,emojiarea.options.emojiMenuLocation),$(this.$menu).css("z-index",++EmojiMenu.menuZIndex),this.$menu.show("fast"),this.currentCategory||this.load(0),this.visible=!0,this.tether.position()},angular.module("ngEmojiPicker",[]).directive("emojiPicker",function($parse){return{link:function(scope,element,attrs){console.log(attrs);var emojiAttachmentLocation=attrs.emojiAttachmentLocation||"bottom right",emojiMenuLocation=attrs.emojiMenuLocation||"top left";console.log(emojiAttachmentLocation),console.log(emojiMenuLocation),window.emojiPicker=new EmojiPicker({emojiable_selector:"[emoji-picker]",assetsPath:"img/ng-emoji-picker",popupButtonClasses:"fa fa-smile-o",emojiAttachmentLocation:emojiAttachmentLocation,emojiMenuLocation:emojiMenuLocation}),window.emojiPicker.discover()}}})}(jQuery,window,document),function(){angular.module("bots",["ui.router","ui.bootstrap","pascalprecht.translate","ngWebSocket","angularMoment","angularFileUpload","ngEmojiPicker","ngSanitize"]).filter("trusted",["$sce",function($sce){return function(url){return $sce.trustAsResourceUrl(url)}}]).filter("trustedhtml",["$sce",function($sce){return function(html){return $sce.trustAsHtml(html)}}]).filter("replaceWhatsappFormat",function($sce){return function(text){var html=text.replace(/\x2a([^\x2a]+)\x2a/gm,"<strong>$1</strong>");return html=html.replace(/(^|[^A-Za-z0-9])_([^_]+)_($|[^@A-Za-z0-9])/gm,"$1<i>$2</i>$3"),$sce.trustAsHtml(html)}}).run()}(),angular.module("bots").config(translatorConfig),angular.module("bots").constant("$wsEndPoint",$aunoaConfig.wsEndPoint).config(config).run(function($rootScope,$state){$rootScope.$state=$state}),angular.module("bots").factory("wsWebCChat",wsWebCChat),WebChatController.$inject=["wsWebCChat","$scope","$timeout","$rootScope","$location","FileUploader","$translate","$sce","$http"],angular.module("bots").controller("WebChatController",WebChatController);